{% extends "base.html" %}

{% block title %}Compose Email - HR Assistant{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-2">Compose New Email</h1>
                <p class="text-muted">Use AI-powered email generation for HR communications</p>
            </div>
            <div>
                <a href="{{ url_for('email.dashboard') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Email Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">AI-Powered Email Composer</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>How it works:</strong> Describe what email you want to send in natural language.
                    The AI will understand the context and generate appropriate emails automatically.
                </div>

                <form id="composeForm">
                    <div class="mb-4">
                        <label for="hrQuery" class="form-label">
                            <strong>HR Email Request</strong>
                        </label>
                        <textarea class="form-control" id="hrQuery" rows="4"
                                  placeholder="Example: Send offer letter to John Doe for Software Engineer position in Technical department, joining date March 1st 2024"
                                  required></textarea>
                        <div class="form-text">
                            Describe the email type, recipient(s), and any relevant details
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><strong>Supported Email Types:</strong></label>
                        <div class="row">
                            <div class="col-md-6">
                                <select class="form-select mb-2" id="emailTypeHelper" onchange="insertTemplate()">
                                    <option value="">-- Quick Insert Template --</option>
                                    <option value="offer letter">Offer Letter</option>
                                    <option value="appointment letter">Appointment Letter</option>
                                    <option value="joining reminder">Joining Reminder</option>
                                    <option value="onboarding schedule">Onboarding Schedule</option>
                                    <option value="probation completion">Probation Completion</option>
                                    <option value="promotion">Promotion</option>
                                    <option value="salary increment">Salary Increment</option>
                                    <option value="leave approval">Leave Approval</option>
                                    <option value="leave rejection">Leave Rejection</option>
                                    <option value="attendance warning">Attendance Warning</option>
                                    <option value="performance warning">Performance Warning</option>
                                    <option value="appreciation">Appreciation</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <select class="form-select mb-2" id="emailTypeHelper2" onchange="insertTemplate2()">
                                    <option value="">-- More Templates --</option>
                                    <option value="project assignment">Project Assignment</option>
                                    <option value="training invitation">Training Invitation</option>
                                    <option value="meeting invite">Meeting Invite</option>
                                    <option value="task reminder">Task Reminder</option>
                                    <option value="birthday">Birthday Greeting</option>
                                    <option value="work anniversary">Work Anniversary</option>
                                    <option value="farewell">Farewell</option>
                                    <option value="resignation acceptance">Resignation Acceptance</option>
                                    <option value="termination">Termination</option>
                                    <option value="holiday announcement">Holiday Announcement</option>
                                    <option value="policy update">Policy Update</option>
                                    <option value="general announcement">General Announcement</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg" id="sendBtn">
                            <span class="spinner-border spinner-border-sm d-none" role="status" id="sendSpinner"></span>
                            <i class="bi bi-send"></i> Generate and Send Email
                        </button>
                    </div>
                </form>

                <div id="resultContainer" class="mt-4" style="display: none;">
                    <hr>
                    <h6>Result:</h6>
                    <div id="resultContent"></div>
                </div>
            </div>
        </div>

        <!-- Examples Card -->
        <div class="card shadow mt-4">
            <div class="card-header bg-secondary text-white">
                <h6 class="mb-0">Example Queries</h6>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li class="mb-2">
                        <code>Send offer letter to Sarah Khan for Senior Developer position, joining on March 15, 2024</code>
                    </li>
                    <li class="mb-2">
                        <code>Send birthday wishes to all employees with birthday today</code>
                    </li>
                    <li class="mb-2">
                        <code>Send promotion email to Ali Zaidi, new position: Team Lead</code>
                    </li>
                    <li class="mb-2">
                        <code>Send meeting invite to Technical department for project review on Friday 2 PM</code>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<script>
    function insertTemplate() {
        const select = document.getElementById('emailTypeHelper');
        const textarea = document.getElementById('hrQuery');
        if (select.value) {
            textarea.value = `Send ${select.value} to [employee name] `;
            select.value = '';
            textarea.focus();
        }
    }

    function insertTemplate2() {
        const select = document.getElementById('emailTypeHelper2');
        const textarea = document.getElementById('hrQuery');
        if (select.value) {
            textarea.value = `Send ${select.value} to [employee name] `;
            select.value = '';
            textarea.focus();
        }
    }

    document.getElementById('composeForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const query = document.getElementById('hrQuery').value.trim();
        if (!query) {
            alert('Please enter an email request');
            return;
        }

        const sendBtn = document.getElementById('sendBtn');
        const sendSpinner = document.getElementById('sendSpinner');
        const resultContainer = document.getElementById('resultContainer');
        const resultContent = document.getElementById('resultContent');

        sendBtn.disabled = true;
        sendSpinner.classList.remove('d-none');
        resultContainer.style.display = 'none';

        resultContent.innerHTML = '<div class="alert alert-info"><i class="bi bi-hourglass-split"></i> Processing your request... Generating email content with AI.</div>';
        resultContainer.style.display = 'block';

        try {
            const response = await fetch('/email/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query: query })
            });

            const data = await response.json();

            if (data.success) {
                let html = `<div class="alert alert-success">
                    <h5><i class="bi bi-check-circle"></i> Success!</h5>
                    <p><strong>Email Type:</strong> ${data.email_type || 'Unknown'}</p>
                    <p>${data.message}</p>
                </div>`;

                if (data.results && data.results.length > 0) {
                    html += '<div class="card mt-3"><div class="card-header bg-light"><strong>Email Details:</strong></div><div class="card-body">';
                    data.results.forEach((result, idx) => {
                        html += `
                            <div class="mb-3 p-3 border rounded">
                                <h6>Email ${idx + 1}:</h6>
                                <p class="mb-1"><strong>Recipient:</strong> ${result.recipient} (${result.email})</p>
                                <p class="mb-1"><strong>Subject:</strong> ${result.subject}</p>
                                <p class="mb-0"><strong>Status:</strong> 
                                    <span class="badge ${result.status.includes('sent') ? 'bg-success' : 'bg-warning'}">
                                        ${result.status}
                                    </span>
                                </p>
                            </div>
                        `;
                    });
                    html += '</div></div>';
                    
                    html += `<div class="mt-3">
                        <a href="${window.location.origin}/email/sent" class="btn btn-primary">
                            <i class="bi bi-inbox"></i> View Sent Emails
                        </a>
                        <a href="${window.location.origin}/email/dashboard" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Back to Dashboard
                        </a>
                    </div>`;
                }
                
                resultContent.innerHTML = html;
                document.getElementById('hrQuery').value = ''; // Clear form
            } else {
                let errorHtml = `<div class="alert alert-danger">
                    <h5><i class="bi bi-exclamation-triangle"></i> Error</h5>
                    <p>${data.message}</p>
                </div>`;

                if (data.suggestions && data.suggestions.length > 0) {
                    errorHtml += '<div class="alert alert-info"><strong>Suggested email types:</strong><ul class="mb-0">';
                    data.suggestions.forEach(s => {
                        errorHtml += `<li>${s}</li>`;
                    });
                    errorHtml += '</ul></div>';
                }

                if (data.available_employees && data.available_employees.length > 0) {
                    errorHtml += `<div class="alert alert-info"><strong>Available employees:</strong> ${data.available_employees.join(', ')}</div>`;
                }

                resultContent.innerHTML = errorHtml;
            }
        } catch (error) {
            console.error('Error:', error);
            resultContent.innerHTML = `
                <div class="alert alert-danger">
                    <h5><i class="bi bi-exclamation-triangle"></i> Network Error</h5>
                    <p>Failed to communicate with the server. Please try again.</p>
                    <p class="mb-0"><small>Error: ${error.message}</small></p>
                </div>
            `;
        } finally {
            sendBtn.disabled = false;
            sendSpinner.classList.add('d-none');
            
            // Scroll to results
            resultContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    });
</script>
{% endblock %}
